TITLE = Vita_Doom
HOMEBREW_C_SRCS := $(wildcard src/*.c)
HOMEBREW_CPP_SRCS := $(wildcard src/*.cpp)
HOMEBREW_OBJS = $(patsubst src/%,bin/%,$(HOMEBREW_C_SRCS:.c=.o)) $(patsubst src/%,bin/%,$(HOMEBREW_CPP_SRCS:.cpp=.o))

PREFIX = arm-vita-eabi
CC = $(PREFIX)-gcc
CCP = $(PREFIX)-g++
CFLAGS = -Wall -fno-exceptions -Ofast -DPSP2 -DDEBUG -mcpu=cortex-a9 -mthumb -mfpu=neon
CPPFLAGS = $(CFLAGS)

all: $(TITLE)

TEST_OUTPUT = bin/*.S out/$(TITLE).elf out/$(TITLE).velf bin/*.o lib/*.a lib/*.o lib/*.S lib/Makefile
LIBS = lib/libSceKernel_stub.a lib/libSceTouch_stub.a lib/libSceDisplay_stub.a lib/libSceGxm_stub.a \
lib/libSceCtrl_stub.a lib/libSceRtc_stub.a

.PHONY: $(TITLE)
$(TITLE): out/$(TITLE).elf
	$(PREFIX)-strip -g $<
	vita-elf-create out/$(TITLE).elf out/$(TITLE).velf db.json

out/$(TITLE).elf: $(HOMEBREW_OBJS) $(LIBS)
	mkdir -p out
	$(CC) -Wl,-q $(LDFLAGS) $(HOMEBREW_OBJS) -lvita2d -lm $(LIBS) -o $@

bin/%.o: src/%.c
	mkdir -p bin
	$(CC) $(CFLAGS) -c $< -o $@

bin/%.o: src/%.cpp
	mkdir -p bin
	$(CCP) $(CFLAGS) -c $< -o $@

lib/%.a: db.json
	mkdir -p lib
	vita-libs-gen db.json lib/
	$(MAKE) -C lib $*.a

clean:
	rm -f $(ALL_OBJS:.o=.d) $(TARGETS) $(TEST_OUTPUT)
